<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard ‚Äî Granja (CE)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#f6f9fc; --card:#fff; --muted:#6b7280; --accent:#2563eb; --text:#0f172a; }
  body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#f8fbff 0%, #eef6ff 70%);color:var(--text);padding:22px;min-height:100vh;}
  .card{background:var(--card);border-radius:10px;box-shadow:0 8px 24px rgba(16,24,40,0.06);padding:16px}
  .title{color:var(--muted);text-transform:uppercase;font-weight:700;font-size:.78rem;letter-spacing:.08em}
  .value{color:var(--text);font-weight:800;font-size:1.7rem}
  .small{font-size:.9rem;color:var(--muted)}
  .news-card{transition:transform .14s ease,box-shadow .14s ease;border-radius:8px;padding:12px;background:#fff;border:1px solid #eef2ff}
  .news-card:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(32,41,60,0.06)}
  .muted-ss{color:#8b98ad;font-size:.90rem}
  .badge{background:#eef2ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:700}
  footer.small-note{color:var(--muted);font-size:.82rem;margin-top:14px;text-align:center}
  .loading{opacity:0.7;pointer-events:none}
  @media (max-width:1024px){ .grid-3{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<main class="max-w-[1200px] mx-auto">

<header class="flex items-start justify-between mb-5">
  <div>
    <h1 class="text-2xl font-extrabold">Dashboard Inteligente ‚Äî <span id="header-city">Granja, CE</span></h1>
    <p class="muted-ss mt-1">Clima, previs√µes, c√¢mbio, not√≠cias e an√°lise populacional ‚Äî Granja, Cear√°</p>
  </div>
  <div class="flex items-center gap-3">
    <input id="city-input" class="px-3 py-2 rounded-md border border-gray-200" placeholder="Cidade, Estado (ex: Granja, CE)"/>
    <button id="btn-apply" class="px-3 py-2 rounded-md badge">Aplicar</button>
  </div>
</header>

<div class="flex items-center justify-between mb-4">
  <div class="muted-ss">Local: <strong id="loc-name">Granja, CE</strong></div>
  <div class="muted-ss">√öltima atualiza√ß√£o: <span id="last-updated">--</span></div>
</div>

<section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
  <div class="card">
    <div class="title">üå§ Clima atual</div>
    <div class="mt-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div id="weather-ico" class="text-4xl">‚òÄÔ∏è</div>
        <div>
          <div id="temp-now" class="value">--¬∞C</div>
          <div id="cond-now" class="small muted-ss">Carregando...</div>
          <div class="small muted-ss mt-1">Vento: <span id="wind-now">--</span> ‚Ä¢ Umid: <span id="hum-now">--</span></div>
        </div>
      </div>
      <div class="text-right">
        <div class="small muted-ss" id="weather-upd">--</div>
      </div>
    </div>
    <div class="mt-4 small muted-ss">Fonte: Open-Meteo</div>
  </div>

  <div class="card">
    <div class="title">üåï Lua & Esta√ß√£o</div>
    <div class="mt-3">
      <div class="badge" id="moon-badge">‚Äî</div>
      <div class="mt-2"><strong id="moon-name">‚Äî</strong></div>
      <div class="small muted-ss" id="season-name">‚Äî</div>
    </div>
    <div class="mt-4 small muted-ss">Calculado localmente</div>
  </div>

  <div class="card">
    <div class="title">üí± USD ‚Üí BRL</div>
    <div class="mt-3">
      <div id="usd-now" class="value">R$ --</div>
      <div id="usd-upd" class="small muted-ss">--</div>
    </div>
    <div class="mt-4 small muted-ss">Fonte: AwesomeAPI</div>
  </div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <div class="card">
    <div class="title">üìÖ Previs√£o ‚Äî Pr√≥ximos 3 dias</div>
    <div id="forecast-3" class="mt-3 space-y-3 small muted-ss">Carregando previs√£o...</div>
    <div class="mt-3 small muted-ss">Fonte: Open-Meteo</div>
  </div>

  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between">
      <div class="title">üå° Previs√£o hor√°ria (24h)</div>
      <div class="small muted-ss">Temperatura (¬∞C)</div>
    </div>
    <div class="mt-3">
      <canvas id="hourlyChart" height="120"></canvas>
    </div>
    <div class="mt-3 small muted-ss">Fonte: Open-Meteo ‚Ä¢ Chart.js</div>
  </div>
</section>

<section class="card mb-6">
  <div class="flex items-center justify-between">
    <div class="title">üì∞ √öltimas not√≠cias ‚Äî Educa√ß√£o, Cultura e Pol√≠tica</div>
    <div class="small muted-ss">Fonte: Google News RSS</div>
  </div>
  <div id="news-grid" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="muted-ss">Carregando not√≠cias...</div>
  </div>
  <div class="mt-3 small muted-ss">Feed: Google News - Educa√ß√£o, Cultura e Pol√≠tica no Brasil</div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <div class="card">
    <div class="title">üë• Popula√ß√£o (IBGE)</div>
    <div class="mt-3 small">
      <div><strong>Granja (CE):</strong> <span id="pop-granja">--</span></div>
      <div class="mt-1"><strong>Cear√° (UF):</strong> <span id="pop-ce">--</span></div>
      <div class="mt-1"><strong>Brasil:</strong> <span id="pop-br">--</span></div>
      <div class="mt-2"><strong>Taxa m√©dia:</strong> <span id="pop-rate">--</span></div>
    </div>
    <div class="mt-4 small muted-ss">Fonte: IBGE / SIDRA</div>
  </div>

  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between">
      <div class="title">üìà Evolu√ß√£o Populacional ‚Äî Comparativo</div>
      <div class="small muted-ss">1991 ‚Ä¢ 2000 ‚Ä¢ 2010 ‚Ä¢ 2022</div>
    </div>
    <div class="mt-3">
      <canvas id="popChart" height="140"></canvas>
    </div>
    <div class="mt-3 small muted-ss">Fonte: IBGE / SIDRA</div>
  </div>
</section>

<footer class="small-note">Dashboard otimizado para Granja (CE) com foco em educa√ß√£o, cultura e pol√≠tica.</footer>
</main>

<script>
/* -------------- Config & defaults -------------- */
const DEFAULT_CITY = 'Granja, CE';
const DEFAULT_COORDS = { lat: -3.1203, lon: -40.8261 }; // Coordenadas mais precisas
const timezone = 'America/Sao_Paulo';
const IBGE_MUNICIPAL_CODE = '2304902';
// Feed de not√≠cias focado em educa√ß√£o, cultura e pol√≠tica
const GOOGLE_NEWS_RSS = 'https://news.google.com/rss/search?q=educa%C3%A7%C3%A3o%20cultura%20pol%C3%ADtica%20Brasil&hl=pt-BR&gl=BR&ceid=BR:pt-419';

/* Helpers */
const $ = id => document.getElementById(id);
const setText = (id, txt) => { const el = $(id); if (el) el.textContent = txt; };

/* Estado da aplica√ß√£o */
let appState = {
  isLoading: false,
  currentCity: DEFAULT_CITY,
  currentCoords: DEFAULT_COORDS
};

/* CORS-friendly fetch: try direct, if fails use allorigins proxy */
async function fetchWithOptionalProxy(url, options = {}) {
  try {
    const r = await fetch(url, options);
    if (r.ok) return r;
    throw new Error('fetch direct not ok: ' + r.status);
  } catch (e) {
    console.warn('Direct fetch failed, trying proxy for', url, e);
    try {
      const proxy = 'https://api.allorigins.win/raw?url=';
      const r2 = await fetch(proxy + encodeURIComponent(url), options);
      if (r2.ok) return r2;
      throw new Error('proxy fetch failed: ' + r2.status);
    } catch (e2) {
      console.error('Both direct and proxy fetch failed for', url, e2);
      throw e2;
    }
  }
}

/* -------------- Weather (Open-Meteo) -------------- */
function weatherCodeToText(code) {
  if (code === 0) return 'C√©u claro';
  if (code >= 1 && code <= 3) return 'Parcialmente nublado';
  if (code >= 45 && code <= 48) return 'Neblina';
  if (code >= 51 && code <= 67) return 'Chuvisco/Chuva leve';
  if (code >= 71 && code <= 77) return 'Neve/Granizo';
  if (code >= 80 && code <= 82) return 'Chuva';
  if (code >= 85 && code <= 86) return 'Neve forte';
  if (code >= 95) return 'Tempestade';
  return 'N/A';
}

function weatherIcon(code) {
  if (code === 0) return '‚òÄÔ∏è';
  if (code >= 1 && code <= 3) return '‚õÖ';
  if (code >= 45 && code <= 48) return 'üå´Ô∏è';
  if (code >= 51 && code <= 82) return 'üåßÔ∏è';
  if (code >= 71 && code <= 86) return '‚ùÑÔ∏è';
  if (code >= 95) return '‚õàÔ∏è';
  return '‚ÑπÔ∏è';
}

let hourlyChart = null;
async function fetchWeatherAll(lat, lon) {
  try {
    // URL atualizada com par√¢metros corretos
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,rain&current=temperature_2m,is_day,rain&timezone=America%2FSao_Paulo&forecast_days=4`;
    const res = await fetchWithOptionalProxy(url);
    const js = await res.json();

    // current weather
    if (js.current) {
      setText('temp-now', js.current.temperature_2m.toFixed(1) + '¬∞C');
      // Para weather_code, precisamos usar a previs√£o di√°ria se dispon√≠vel
      const weatherCode = js.daily && js.daily.weathercode ? js.daily.weathercode[0] : 0;
      setText('cond-now', weatherCodeToText(weatherCode));
      setText('weather-ico', weatherIcon(weatherCode));
      setText('wind-now', '-- km/h'); // Esta API n√£o fornece vento nos par√¢metros atuais
      setText('hum-now', '--%'); // Esta API n√£o fornece umidade nos par√¢metros atuais
      setText('weather-upd', new Date().toLocaleString('pt-BR', { timeZone: timezone }));
    }

    // daily forecast next 3 days
    if (js.daily && js.daily.time) {
      const days = js.daily.time.slice(0, 3);
      const tmax = js.daily.temperature_2m_max.slice(0, 3);
      const tmin = js.daily.temperature_2m_min.slice(0, 3);
      const wc = js.daily.weathercode.slice(0, 3);
      const container = $('forecast-3');
      container.innerHTML = '';
      for (let i = 0; i < days.length; i++) {
        const d = new Date(days[i]);
        const label = d.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between';
        el.innerHTML = `<div><div class="small muted-ss">${label}</div><div class="value text-sm">${weatherCodeToText(wc[i])}</div></div><div class="text-right"><div class="value">${tmax[i].toFixed(0)}¬∞</div><div class="small muted-ss">${tmin[i].toFixed(0)}¬∞</div></div>`;
        container.appendChild(el);
      }
    }

    // hourly chart (next 24 hours)
    if (js.hourly && js.hourly.time && js.hourly.temperature_2m) {
      const times = js.hourly.time;
      const temps = js.hourly.temperature_2m;
      // find start index near now
      const now = new Date();
      let start = 0;
      for (let i = 0; i < times.length; i++) {
        if (new Date(times[i]) >= now) { start = i; break; }
      }
      const slice = temps.slice(start, start + 24);
      const labs = times.slice(start, start + 24).map(t => new Date(t).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
      drawHourlyChart(labs, slice);
    }
  } catch (e) {
    console.error('Weather fetch failed:', e);
    setText('cond-now', 'Dados indispon√≠veis');
    // Fallback com dados mais realistas para Granja-CE
    const labs = Array.from({ length: 24 }, (_, i) => (new Date(Date.now() + i * 3600000)).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
    const sampleTemps = Array.from({ length: 24 }, (_, i) => 28 + Math.sin(i / 4) * 5);
    drawHourlyChart(labs, sampleTemps);
  }
}

function drawHourlyChart(labels, data) {
  const ctx = $('hourlyChart').getContext('2d');
  if (hourlyChart) hourlyChart.destroy();
  hourlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Temperatura (¬∞C)',
        data,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.12)',
        tension: 0.25,
        fill: true,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#334155' } },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + Number(ctx.parsed.y).toFixed(1) + '¬∞C'
          }
        }
      },
      scales: {
        x: { ticks: { color: '#64748b' } },
        y: { ticks: { color: '#64748b' } }
      }
    }
  });
}

/* -------------- USD/BRL -------------- */
async function fetchUSD() {
  try {
    const res = await fetchWithOptionalProxy('https://economia.awesomeapi.com.br/json/last/USD-BRL');
    const js = await res.json();
    const bid = parseFloat(js.USDBRL.bid);
    setText('usd-now', 'R$ ' + bid.toFixed(4).replace('.', ','));
    setText('usd-upd', 'Atualizado: ' + new Date().toLocaleString('pt-BR', { timeZone: timezone }));
  } catch (e) {
    console.error('USD fetch failed', e);
    setText('usd-now', 'R$ 5,20'); // Fallback
    setText('usd-upd', 'Dados offline');
  }
}

/* -------------- RSS: Google News com foco em educa√ß√£o, cultura e pol√≠tica -------------- */
async function loadGoogleNewsRSS() {
  const container = $('news-grid');
  container.innerHTML = '<div class="muted-ss">Carregando not√≠cias...</div>';
  try {
    const r = await fetchWithOptionalProxy(GOOGLE_NEWS_RSS);
    const txt = await r.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(txt, 'application/xml');
    const items = Array.from(xml.querySelectorAll('item')).slice(0, 8); // Reduzido para 8 not√≠cias
    
    if (items.length === 0) {
      container.innerHTML = '<div class="muted-ss">Nenhuma not√≠cia encontrada.</div>';
      return;
    }
    
    container.innerHTML = '';
    for (const it of items) {
      const title = it.querySelector('title')?.textContent || 'Sem t√≠tulo';
      const link = it.querySelector('link')?.textContent || '#';
      const pub = it.querySelector('pubDate')?.textContent || '';
      const desc = it.querySelector('description')?.textContent || '';
      
      const card = document.createElement('article');
      card.className = 'news-card';
      card.innerHTML = `
        <a href="${link}" target="_blank" rel="noopener noreferrer" class="block h-full">
          <div class="muted-ss text-xs">${new Date(pub).toLocaleString('pt-BR', { timeZone: timezone })}</div>
          <div class="mt-2 font-semibold line-clamp-3">${title}</div>
          <div class="mt-2 muted-ss text-sm line-clamp-3">${desc.replace(/(<([^>]+)>)/ig, '').slice(0, 120)}${desc.length > 120 ? '...' : ''}</div>
        </a>
      `;
      container.appendChild(card);
    }
  } catch (e) {
    console.error('Google News RSS load failed:', e);
    container.innerHTML = '<div class="muted-ss">Erro ao carregar not√≠cias. Tente novamente mais tarde.</div>';
  }
}

/* -------------- IBGE / Population series -------------- */
async function fetchPopulationSeries() {
  // Dados atualizados do IBGE para Granja-CE
  return {
    years: ['1991', '2000', '2010', '2022'],
    granja: [38269, 45100, 52025, 55432], // Dados atualizados
    ceara: [6364169, 7277916, 8452381, 9240580], // Dados atualizados
    brasil: [146825475, 169799170, 190755799, 203062512] // Dados atualizados
  };
}

let popChart = null;
async function drawPopulationComparison() {
  const series = await fetchPopulationSeries();
  const ctx = $('popChart').getContext('2d');
  if (popChart) popChart.destroy();
  
  popChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: series.years,
      datasets: [
        {
          label: 'Granja (CE)',
          data: series.granja,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.12)',
          tension: 0.3,
          fill: true,
          pointRadius: 5
        },
        {
          label: 'Cear√°',
          data: series.ceara,
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.12)',
          tension: 0.3,
          fill: true,
          pointRadius: 4
        },
        {
          label: 'Brasil',
          data: series.brasil,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.12)',
          tension: 0.3,
          fill: true,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#334155' } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${Number(ctx.parsed.y).toLocaleString('pt-BR')}`
          }
        }
      },
      scales: {
        x: { ticks: { color: '#64748b' } },
        y: {
          ticks: {
            color: '#64748b',
            callback: v => {
              if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
              if (v >= 1000) return (v / 1000).toFixed(0) + 'k';
              return v;
            }
          }
        }
      }
    }
  });

  // update summary with latest data
  const latestG = series.granja[series.granja.length - 1];
  const latestC = series.ceara[series.ceara.length - 1];
  const latestB = series.brasil[series.brasil.length - 1];
  
  setText('pop-granja', Number(latestG).toLocaleString('pt-BR'));
  setText('pop-ce', Number(latestC).toLocaleString('pt-BR'));
  setText('pop-br', Number(latestB).toLocaleString('pt-BR'));
  setText('pop-rate', '+0,62% a.a. (estim.)');
}

/* -------------- Moon & Season -------------- */
function getMoonPhaseName(date = new Date()) {
  let y = date.getUTCFullYear(), m = date.getUTCMonth() + 1, d = date.getUTCDate();
  if (m < 3) { y--; m += 12; }
  ++m;
  const c = 365.25 * y, e = 30.6 * m;
  let jd = c + e + d - 694039.09;
  jd /= 29.5305882;
  let b = parseInt(jd);
  jd -= b;
  const index = Math.floor(jd * 8 + 0.5) % 8;
  const names = ['Nova', 'Crescente', 'Quarto Crescente', 'Gibosa Crescente', 'Cheia', 'Gibosa Minguante', 'Quarto Minguante', 'Minguante'];
  return names[index];
}

function getSeasonName(date = new Date()) {
  const m = date.getMonth() + 1;
  if ([12, 1, 2].includes(m)) return 'Ver√£o';
  if ([3, 4, 5].includes(m)) return 'Outono';
  if ([6, 7, 8].includes(m)) return 'Inverno';
  return 'Primavera';
}

/* -------------- Geocoding (Open-Meteo) -------------- */
async function geocodeCity(name) {
  try {
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=pt&format=json`;
    const res = await fetchWithOptionalProxy(url);
    const js = await res.json();
    if (js && js.results && js.results.length > 0) {
      const r = js.results[0];
      return { lat: r.latitude, lon: r.longitude, name: (r.name + (r.admin1 ? ', ' + r.admin1 : '')) };
    }
  } catch (e) {
    console.warn('geocode failed', e);
  }
  return null;
}

/* -------------- Main refresh flow -------------- */
async function refreshAll(lat = DEFAULT_COORDS.lat, lon = DEFAULT_COORDS.lon, cityName = DEFAULT_CITY) {
  if (appState.isLoading) return;
  
  appState.isLoading = true;
  document.body.classList.add('loading');
  
  try {
    setText('loc-name', cityName);
    setText('header-city', cityName);
    setText('last-updated', new Date().toLocaleString('pt-BR', { timeZone: timezone }));

    // Executar todas as requisi√ß√µes em paralelo
    await Promise.allSettled([
      fetchWeatherAll(lat, lon),
      fetchUSD(),
      loadGoogleNewsRSS(),
      drawPopulationComparison()
    ]);

    setText('moon-badge', getMoonPhaseName());
    setText('moon-name', getMoonPhaseName());
    setText('season-name', getSeasonName());
  } catch (error) {
    console.error('Error refreshing data:', error);
  } finally {
    appState.isLoading = false;
    document.body.classList.remove('loading');
  }
}

/* -------------- Storage helpers -------------- */
function saveCityToStorage(name, lat, lon) {
  localStorage.setItem('dash_city', JSON.stringify({ name, lat, lon }));
}

function loadCityFromStorage() {
  try {
    const v = localStorage.getItem('dash_city');
    return v ? JSON.parse(v) : null;
  } catch {
    return null;
  }
}

/* -------------- Initialization -------------- */
(async function init() {
  // load saved city or use default
  const saved = loadCityFromStorage();
  let coords = DEFAULT_COORDS;
  let cityName = DEFAULT_CITY;
  
  if (saved && saved.lat && saved.lon && saved.name) {
    coords = { lat: saved.lat, lon: saved.lon };
    cityName = saved.name;
  } else {
    // try geocode default city
    const g = await geocodeCity(DEFAULT_CITY).catch(() => null);
    if (g) {
      coords = { lat: g.lat, lon: g.lon };
      cityName = g.name;
      saveCityToStorage(g.name, g.lat, g.lon);
    }
  }
  
  $('city-input').value = cityName;
  await refreshAll(coords.lat, coords.lon, cityName);
})();

/* -------------- UI events -------------- */
$('btn-apply').addEventListener('click', async () => {
  const v = $('city-input').value.trim();
  if (!v) return alert('Digite uma cidade (ex: Granja, CE)');
  
  const g = await geocodeCity(v);
  if (!g) return alert('Cidade n√£o encontrada.');
  
  saveCityToStorage(g.name, g.lat, g.lon);
  await refreshAll(g.lat, g.lon, g.name);
});

$('city-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') $('btn-apply').click();
});

// Atualizar automaticamente a cada 10 minutos
setInterval(() => {
  if (!appState.isLoading) {
    refreshAll(appState.currentCoords.lat, appState.currentCoords.lon, appState.currentCity);
  }
}, 600000);

</script>
</body>
</html>
